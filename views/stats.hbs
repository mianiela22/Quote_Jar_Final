<div class="container">
    <div class="page-header">
        <h1>üìä Statistics</h1>
        <a href="/home" class="btn btn-secondary">‚Üê Back to Quotes</a>
    </div>

    <div class="stats-summary">
        <div class="stat-box">
            <h3 id="total-quotes">0</h3>
            <p>Total Quotes</p>
        </div>
        <div class="stat-box">
            <h3 id="total-people">0</h3>
            <p>People Quoted</p>
        </div>
        <div class="stat-box">
            <h3 id="funniest-person">-</h3>
            <p>Funniest Person</p>
        </div>
    </div>

    <div class="stats-container">
        <div class="chart-card">
            <h2>üèÜ Top 5 Funniest People</h2>
            <div class="chart-wrapper">
                <canvas id="personChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h2>üç© Quote Distribution</h2>
            <div class="chart-wrapper">
                <canvas id="donutChart"></canvas>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <div class="chart-card">
            <h2>üìè Who Has the Longest Quotes?</h2>
            <div class="chart-wrapper">
                <canvas id="lengthChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h2>üìÖ Quotes by Month</h2>
            <div class="chart-wrapper">
                <canvas id="monthChart"></canvas>
            </div>
            <p style="text-align: center; color: #999; margin-top: 1rem; font-size: 0.9rem;">
                Only showing quotes with dates
            </p>
        </div>
    </div>

    <div class="chart-card" style="margin-top: 2rem;">
        <h2>üìã Everyone's Quote Count</h2>
        <div class="person-list">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
    // Get the quotes data from the server
    const quotesData = {{{quotesJSON}}};
    
    // Process data for "Funniest Person" chart
    const personCounts = {};
    quotesData.forEach(quote => {
        if (personCounts[quote.personName]) {
            personCounts[quote.personName]++;
        } else {
            personCounts[quote.personName] = 1;
        }
    });
    
    // Sort by count and get top 5
    const sortedPeople = Object.entries(personCounts)
        .sort((a, b) => b[1] - a[1]);
    
    const top5People = sortedPeople.slice(0, 5);
    const personNames = top5People.map(p => p[0]);
    const personQuoteCounts = top5People.map(p => p[1]);
    
    // Update summary stats
    document.getElementById('total-quotes').textContent = quotesData.length;
    document.getElementById('total-people').textContent = Object.keys(personCounts).length;
    document.getElementById('funniest-person').textContent = sortedPeople[0] ? sortedPeople[0][0] : '-';
    
    // Create "Top 5 Funniest People" bar chart
    const personCtx = document.getElementById('personChart').getContext('2d');
    new Chart(personCtx, {
        type: 'bar',
        data: {
            labels: personNames,
            datasets: [{
                label: 'Number of Quotes',
                data: personQuoteCounts,
                backgroundColor: 'rgba(147, 51, 234, 0.8)',
                borderColor: 'rgba(147, 51, 234, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#666'
                    },
                    grid: {
                        color: '#e5e5e5'
                    }
                },
                x: {
                    ticks: {
                        color: '#666'
                    },
                    grid: {
                        color: '#e5e5e5'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Create Donut Chart - Top 5 distribution
    const donutCtx = document.getElementById('donutChart').getContext('2d');
    const donutColors = [
        'rgba(147, 51, 234, 0.8)',
        'rgba(59, 130, 246, 0.8)',
        'rgba(236, 72, 153, 0.8)',
        'rgba(34, 197, 94, 0.8)',
        'rgba(251, 146, 60, 0.8)'
    ];
    
    new Chart(donutCtx, {
        type: 'doughnut',
        data: {
            labels: personNames,
            datasets: [{
                data: personQuoteCounts,
                backgroundColor: donutColors,
                borderColor: '#fff',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        },
                        color: '#666'
                    }
                }
            }
        }
    });
    
    // Calculate average quote length per person
    const personLengths = {};
    quotesData.forEach(quote => {
        if (!personLengths[quote.personName]) {
            personLengths[quote.personName] = {
                totalLength: 0,
                count: 0
            };
        }
        personLengths[quote.personName].totalLength += quote.quoteText.length;
        personLengths[quote.personName].count++;
    });
    
    // Calculate averages and sort
    const avgLengths = Object.entries(personLengths).map(([name, data]) => ({
        name: name,
        avgLength: Math.round(data.totalLength / data.count)
    })).sort((a, b) => b.avgLength - a.avgLength);
    
    // Get top 5 longest
    const top5Longest = avgLengths.slice(0, 5);
    const longestNames = top5Longest.map(p => p.name);
    const longestLengths = top5Longest.map(p => p.avgLength);
    
    // Create "Longest Quotes" bar chart
    const lengthCtx = document.getElementById('lengthChart').getContext('2d');
    new Chart(lengthCtx, {
        type: 'bar',
        data: {
            labels: longestNames,
            datasets: [{
                label: 'Average Quote Length (characters)',
                data: longestLengths,
                backgroundColor: 'rgba(236, 72, 153, 0.8)',
                borderColor: 'rgba(236, 72, 153, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#666'
                    },
                    grid: {
                        color: '#e5e5e5'
                    }
                },
                x: {
                    ticks: {
                        color: '#666'
                    },
                    grid: {
                        color: '#e5e5e5'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Process data for "Funniest Month" chart
    const monthCounts = {};
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    quotesData.forEach(quote => {
        if (quote.date) {
            const date = new Date(quote.date);
            const month = monthNames[date.getMonth()];
            if (monthCounts[month]) {
                monthCounts[month]++;
            } else {
                monthCounts[month] = 1;
            }
        }
    });
    
    const months = Object.keys(monthCounts);
    const monthQuoteCounts = Object.values(monthCounts);
    
    // Create "Funniest Month" bar chart
    const monthCtx = document.getElementById('monthChart').getContext('2d');
    new Chart(monthCtx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Number of Quotes',
                data: monthQuoteCounts,
                backgroundColor: 'rgba(147, 51, 234, 0.8)',
                borderColor: 'rgba(147, 51, 234, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#666'
                    },
                    grid: {
                        color: '#e5e5e5'
                    }
                },
                x: {
                    ticks: {
                        color: '#666'
                    },
                    grid: {
                        color: '#e5e5e5'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Create full person list
    const personListDiv = document.querySelector('.person-list');
    sortedPeople.forEach((person, index) => {
        const personItem = document.createElement('div');
        personItem.className = 'person-item';
        personItem.innerHTML = `
            <span class="person-rank">#${index + 1}</span>
            <span class="person-name">${person[0]}</span>
            <span class="person-count">${person[1]} quote${person[1] > 1 ? 's' : ''}</span>
        `;
        personListDiv.appendChild(personItem);
    });
</script>

<style>
.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.stat-box {
    background: #f5f5f5;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #e5e5e5;
}

.stat-box h3 {
    font-size: 2.5rem;
    font-weight: 800;
    color: #1a1a1a;
    margin-bottom: 0.5rem;
}

.stat-box p {
    color: #666;
    font-size: 0.95rem;
    font-weight: 600;
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-wrapper {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.person-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 0.75rem;
    margin-top: 1.5rem;
}

.person-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 6px;
    border: 1px solid #e5e5e5;
}

.person-rank {
    font-weight: 800;
    color: #999;
    font-size: 1.1rem;
    min-width: 40px;
}

.person-name {
    flex: 1;
    font-weight: 600;
    color: #1a1a1a;
}

.person-count {
    color: #666;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .stats-container {
        grid-template-columns: 1fr;
    }
}
</style>