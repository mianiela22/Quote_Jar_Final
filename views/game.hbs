<div class="container">
    <div class="page-header">
        <h1>üéÆ Quiz Game: Guess Who Said It!</h1>
        <a href="/" class="btn btn-secondary">‚Üê Back to Quotes</a>
    </div>

    {{#if error}}
        <div class="empty-state">
            <h2>{{error}}</h2>
            <p>Add more quotes to start playing!</p>
            <a href="/add-quote" class="btn btn-primary">Add Quotes</a>
        </div>
    {{else}}
        <div class="game-container">
            <div class="score-board">
                <div class="score-item">
                    <span class="score-label">Score:</span>
                    <span class="score-value" id="score">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">Question:</span>
                    <span class="score-value"><span id="current-question">1</span>/<span id="total-questions">10</span></span>
                </div>
            </div>

            <div class="quote-display">
                <p class="game-quote-text" id="quote-text"></p>
            </div>

            <div class="answer-buttons" id="answer-buttons">
                <!-- Buttons will be generated by JavaScript -->
            </div>

            <div class="feedback" id="feedback"></div>

            <button class="btn btn-primary btn-large" id="next-btn" style="display: none;">Next Question ‚Üí</button>
            
            <div class="game-over" id="game-over" style="display: none;">
                <h2>üéâ Game Over!</h2>
                <p>Your final score: <span id="final-score"></span>/<span id="final-total"></span></p>
                <button class="btn btn-primary btn-large" onclick="location.reload()">Play Again</button>
                <a href="/" class="btn btn-secondary btn-large">Back to Quotes</a>
            </div>
        </div>
    {{/if}}
</div>

<script>
    const allQuotes = {{{quotesJSON}}};
    
    if (allQuotes && allQuotes.length >= 2) {
        let score = 0;
        let currentQuestion = 0;
        const totalQuestions = Math.min(10, allQuotes.length);
        let usedQuotes = [];
        let currentQuote = null;
        
        // Get unique person names
        function getUniquePeople() {
            const people = [...new Set(allQuotes.map(q => q.personName))];
            return people;
        }
        
        // Shuffle array
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // Get a random quote that hasn't been used
        function getRandomQuote() {
            const availableQuotes = allQuotes.filter(q => !usedQuotes.includes(q.id));
            if (availableQuotes.length === 0) return null;
            
            const randomIndex = Math.floor(Math.random() * availableQuotes.length);
            const quote = availableQuotes[randomIndex];
            usedQuotes.push(quote.id);
            return quote;
        }
        
        // Generate answer options
        function generateAnswerOptions(correctPerson) {
            const allPeople = getUniquePeople();
            let options = [correctPerson];
            
            // Add wrong answers
            const otherPeople = allPeople.filter(p => p !== correctPerson);
            const shuffledOthers = shuffleArray(otherPeople);
            
            // Add 2-3 wrong answers depending on how many people we have
            const numWrongAnswers = Math.min(3, otherPeople.length);
            for (let i = 0; i < numWrongAnswers; i++) {
                options.push(shuffledOthers[i]);
            }
            
            return shuffleArray(options);
        }
        
        // Display question
        function displayQuestion() {
            currentQuote = getRandomQuote();
            
            if (!currentQuote || currentQuestion >= totalQuestions) {
                endGame();
                return;
            }
            
            currentQuestion++;
            document.getElementById('current-question').textContent = currentQuestion;
            document.getElementById('total-questions').textContent = totalQuestions;
            document.getElementById('quote-text').textContent = `"${currentQuote.quoteText}"`;
            
            const options = generateAnswerOptions(currentQuote.personName);
            const buttonsContainer = document.getElementById('answer-buttons');
            buttonsContainer.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = option;
                button.onclick = () => checkAnswer(option, button);
                buttonsContainer.appendChild(button);
            });
            
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('next-btn').style.display = 'none';
        }
        
        // Check answer
        function checkAnswer(selectedPerson, button) {
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(btn => btn.disabled = true);
            
            const feedback = document.getElementById('feedback');
            
            if (selectedPerson === currentQuote.personName) {
                score++;
                document.getElementById('score').textContent = score;
                button.classList.add('correct');
                feedback.textContent = '‚úÖ Correct!';
                feedback.className = 'feedback correct';
            } else {
                button.classList.add('wrong');
                feedback.textContent = `‚ùå Wrong! It was ${currentQuote.personName}`;
                feedback.className = 'feedback wrong';
                
                // Highlight correct answer
                buttons.forEach(btn => {
                    if (btn.textContent === currentQuote.personName) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            document.getElementById('next-btn').style.display = 'block';
        }
        
        // End game
        function endGame() {
            document.querySelector('.score-board').style.display = 'none';
            document.querySelector('.quote-display').style.display = 'none';
            document.getElementById('answer-buttons').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-total').textContent = totalQuestions;
            document.getElementById('game-over').style.display = 'block';
        }
        
        // Next button handler
        document.getElementById('next-btn').onclick = displayQuestion;
        
        // Start the game
        displayQuestion();
    }
</script>